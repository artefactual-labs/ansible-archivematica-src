---

###########################################################
#   4- Code install
###########################################################

- name: "symlink archivematica-common source files"
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: "link"
  with_items:
    - src: "{{ archivematica_src_dir }}/archivematica/src/archivematicaCommon/lib"
      dest: "/usr/lib/archivematica/archivematicaCommon"
    - src: "{{ archivematica_src_dir }}/archivematica/src/archivematicaCommon/requirements.txt"
      dest: "/usr/share/archivematica/archivematicaCommon/requirements.txt"
    - src: "{{ archivematica_src_dir }}/archivematica/src/archivematicaCommon/requirements"
      dest: "/usr/share/archivematica/archivematicaCommon/requirements"

- name: "template archivematica-common /etc config"
  template:
    src: "etc_archivematica_archivematicaCommon_dbsettings.j2"
    dest: "/etc/archivematica/archivematicaCommon/dbsettings"
    backup: "yes"

- name: "Copy archivematica-dashboard source files"
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: "link"
  with_items:
    - src: "{{ archivematica_src_dir }}/archivematica/src/dashboard/src"
      dest: "/usr/share/archivematica/dashboard"


- name: "Copy archivematica-mcp-server source files"
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    state: "link"
  with_items:
    - src: "{{ archivematica_src_dir }}/archivematica/src/MCPServer/lib"
      dest: "/usr/lib/archivematica/MCPServer"
    - src: "{{ archivematica_src_dir }}/archivematica/src/MCPServer/share"
      dest: "/usr/share/archivematica/MCPServer"

- name: "template MCPServer /etc config"
  template:
    src: "etc_archivematica_MCPServer_serverConfig.conf.j2"
    dest: "/etc/archivematica/MCPServer/serverConfig.conf"
    backup: "yes"

- name: "Copy archivematica-mcp-client source files"
  file: src={{ item.src }} dest={{ item.dest }} state=link
  with_items:
    - src: "{{ archivematica_src_dir }}/archivematica/src/MCPClient/lib/"
      dest: "/usr/lib/archivematica/MCPClient"

- name: "template MCPClient /etc config"
  template:
    src: "etc_archivematica_MCPClient_clientConfig.conf.j2"
    dest: "/etc/archivematica/MCPClient/clientConfig.conf"
    backup: "yes"

- name: "move archivematicaClientModules to /usr/lib/archivematica/MCPClient"
  file:
    src: "{{ archivematica_src_dir }}/archivematica/src/MCPClient/etc/archivematicaClientModules"
    dest: "/usr/lib/archivematica/MCPClient/archivematicaClientModules"
    state: "link"

- name: "template archivematica-mcp-server init service file"
  template:
    src: "etc_init_archivematica-mcp-server.conf.j2"
    dest: "/etc/init/archivematica-mcp-server.conf"
    backup: "yes"

- name: "template archivematica-mcp-client init service file"
  template:
    src: "etc_init_archivematica-mcp-client.conf.j2"
    dest: "/etc/init/archivematica-mcp-client.conf"
    backup: "yes"

- name: "Reload Upstart configuration"
  command: "initctl reload-configuration"
