---

#
# Common tasks
#

- name: "Define facts (1/2)"
  set_fact:
    is_dev: "{{ archivematica_src_environment_type == 'development' }}"
    is_prod: "{{ archivematica_src_environment_type == 'production' }}"
  tags: "always"

- name: "Define facts (2/2)"
  set_fact:
    archivematica_src_am_dashboard_src_dir: "{{ archivematica_src_dir }}/archivematica/src/dashboard/src"
    archivematica_src_am_dashboard_environment:
      DJANGO_SETTINGS_MODULE: "{{ 'settings.local' if is_dev else 'settings.common' }}"
      ARCHIVEMATICA_DASHBOARD_SECRET_KEY: "{{ archivematica_src_am_dashboad_secret_key }}"
      ARCHIVEMATICA_DASHBOARD_ALLOWED_HOSTS: "{{ archivematica_src_am_dashboad_allowed_hosts }}"
      ARCHIVEMATICA_DASHBOARD_DB_NAME: "{{ archivematica_src_am_dashboad_db_name }}"
      ARCHIVEMATICA_DASHBOARD_DB_USER: "{{ archivematica_src_am_dashboad_db_user }}"
      ARCHIVEMATICA_DASHBOARD_DB_PASSWORD: "{{ archivematica_src_am_dashboad_db_password }}"
      ARCHIVEMATICA_DASHBOARD_DB_HOST: "{{ archivematica_src_am_dashboad_db_host }}"
      ARCHIVEMATICA_DASHBOARD_DB_PORT: "{{ archivematica_src_am_dashboad_db_port }}"
      ARCHIVEMATICA_DASHBOARD_GEARMAN: "{{ archivematica_src_am_dashboad_gearman }}"
      ARCHIVEMATICA_DASHBOARD_ELASTICSEARCH: "{{ archivematica_src_am_dashboad_elasticsearch }}"
      ARCHIVEAMTICA_DASHBOARD_WATCHED_DIR: "{{ archivematica_src_am_dashboad_watched_dir }}"
      ARCHIVEAMTICA_DASHBOARD_SHARED_DIR: "{{ archivematica_src_am_dashboad_shared_dir }}"
    archivematica_src_am_mcpclient_src_dir: "{{ archivematica_src_dir }}/archivematica/src/MCPClient"
    archivematica_src_am_mcpclient_environment:
      ARCHIVEMATICA_MCPCLIENT_SECRET_KEY: "{{ archivematica_src_am_mcpclient_secret_key }}"
      ARCHIVEMATICA_MCPCLIENT_DB_NAME: "{{ archivematica_src_am_mcpclient_db_name }}"
      ARCHIVEMATICA_MCPCLIENT_DB_USER: "{{ archivematica_src_am_mcpclient_db_user }}"
      ARCHIVEMATICA_MCPCLIENT_DB_PASSWORD: "{{ archivematica_src_am_mcpclient_db_password }}"
      ARCHIVEMATICA_MCPCLIENT_DB_HOST: "{{ archivematica_src_am_mcpclient_db_host }}"
      ARCHIVEMATICA_MCPCLIENT_DB_PORT: "{{ archivematica_src_am_mcpclient_db_port }}"
    archivematica_src_am_mcpserver_src_dir: "{{ archivematica_src_dir }}/archivematica/src/MCPServer"
    archivematica_src_am_mcpserver_environment:
      ARCHIVEMATICA_MCPSERVER_SECRET_KEY: "{{ archivematica_src_am_mcpserver_secret_key }}"
      ARCHIVEMATICA_MCPSERVER_DB_NAME: "{{ archivematica_src_am_mcpserver_db_name }}"
      ARCHIVEMATICA_MCPSERVER_DB_USER: "{{ archivematica_src_am_mcpserver_db_user }}"
      ARCHIVEMATICA_MCPSERVER_DB_PASSWORD: "{{ archivematica_src_am_mcpserver_db_password }}"
      ARCHIVEMATICA_MCPSERVER_DB_HOST: "{{ archivematica_src_am_mcpserver_db_host }}"
      ARCHIVEMATICA_MCPSERVER_DB_PORT: "{{ archivematica_src_am_mcpserver_db_port }}"
    archivematica_src_ss_src_dir: "{{ archivematica_src_dir }}/archivematica-storage-service"
    archivematica_src_ss_app_dir: "{{ archivematica_src_dir }}/archivematica-storage-service/storage_service"
    archivematica_src_ss_environment:
      DJANGO_SECRET_KEY: "{{ archivematica_src_ss_secret_key }}"
      DJANGO_STATIC_ROOT: "{{ archivematica_src_dir }}/archivematica-storage-service/storage_service/assets"
      DJANGO_SETTINGS_MODULE: "{{ 'storage_service.settings.local' if is_dev else 'storage_service.settings.local' }}"
      EMAIL_HOST: "{{ archivematica_src_ss_email_host }}"
      EMAIL_HOST_PASSWORD: "{{ archivematica_src_ss_email_host_password }}"
      EMAIL_HOST_USER: "{{ archivematica_src_ss_email_host_user }}"
      EMAIL_PORT: "{{ archivematica_src_ss_email_port }}"
      SS_DB_HOST: "{{ archivematica_src_ss_db_host }}"
      SS_DB_NAME: "{{ archivematica_src_ss_db_name }}"
      SS_DB_PASSWORD: "{{ archivematica_src_ss_db_password }}"
      SS_DB_USER: "{{ archivematica_src_ss_db_user }}"
  tags: "always"

- include: "tear-up.yml"

#
# Components
#

- include: "components/storage-service.yml"
  when: "'archivematica-storage-service' in archivematica_src_components"

- include: "components/mcp-server.yml"
  when: "'archivematica-mcp-server' in archivematica_src_components"

- include: "components/mcp-client.yml"
  when: "'archivematica-mcp-client' in archivematica_src_components"

- include: "components/dashboard.yml"
  when: "'archivematica-dashboard' in archivematica_src_components"

- include: "components/devtools.yml"
  when: "'archivematica-devtools' in archivematica_src_components"

- include: "components/automation-tools.yml"
  when: "'automation-tools' in archivematica_src_components"
