---
# ubuntu block
- block:
    - name: "Install mediaarea.net repo (mediaconch, mediainfo) (Ubuntu >=20.04)"
      apt:
        deb: "https://mediaarea.net/repo/deb/repo-mediaarea_1.0-21_all.deb"
      when:
        - "ansible_distribution_version is version('20.04', '>=')"

    - name: "Update apt cache"
      apt:
        update_cache: yes
      when:
        - "ansible_distribution_version is version('20.04', '>=')"

    - name: "Install MCPClient ext. deps. repo keys"
      apt_key:
        id: "{{ item.id }}"
        url: "{{ item.url }}"
        state: "present"
        validate_certs: "{{ item.validate_certs }}"
      with_items: "{{ MCPClient.osdeps_repokeys }}"
      when:
        - "MCPClient.osdeps_repokeys"

    - name: "Add MCPClient ext. deps. repos (Ubuntu < 20.04)"
      apt_repository:
        repo: "{{ item }}"
        state: "present"
      with_items: "{{ MCPClient.osdeps_repos }}"
      when:
        - "MCPClient.osdeps_repos"
        - "ansible_distribution_version is version('20.04', '<')"

    # Add 1.13.x external-deps focal repo
    - name: "Add MCPClient ext. deps. repos (Ubuntu >= 20.04)"
      apt_repository:
        repo: "{{ item }}"
        state: "present"
      with_items: 
        - "deb [arch=amd64] http://packages.archivematica.org/1.13.x/ubuntu-externals {{ ansible_distribution_release }} main"
      when:
        - "MCPClient.osdeps_repos"
        - "ansible_distribution_version is version('20.04', '>=')"

    - name: "Install MCPClient ext. package deps. (Ubuntu < 20.04)"
      apt:
        pkg: "{{ MCPClient.osdeps_packages | json_query('[].name') }}"
        state: "latest"
      when:
        - "MCPClient.osdeps_packages"
        - "ansible_distribution_version is version('20.04', '<')"
        
    # Exclude ufraw package, not supported on Ubuntu >=20.04
    - name: "Install MCPClient ext. package deps. (Ubuntu >= 20.04)"
      apt:
        pkg: "{{ MCPClient.osdeps_packages | json_query('[].name') | reject('search', 'ufraw') | list }}"
        state: "latest"
      when:
        - "MCPClient.osdeps_packages"
        - "ansible_distribution_version is version('20.04', '>=')"

  when:
    - ansible_distribution == "Ubuntu"

# Centos/RH block
- block:
    - name: "Add MCPClient ext. deps. repos (RH/CentOS)"
      yum_repository:
        name: "{{ item['name'] }}"
        description: "{{ item['description'] }}"
        baseurl: "{{ item['baseurl'] }}"
        gpgcheck: "{{ item['gpgcheck'] }}"
        enabled: "{{ item['enabled'] }}"
      with_items: "{{ MCPClient.osdeps_repos }}"
      when:
        - MCPClient.osdeps_repos

    - name: "Install MCPClient ext. package deps. (RH/CentOS)"
      yum:
        name: "{{ MCPClient.osdeps_packages | json_query('[].name') }}"
        state: "latest"
      when:
        - MCPClient.osdeps_packages is defined and MCPClient.osdeps_packages

    - name: "Install MCPClient ext. package deps. (2) (RH/CentOS)"
      yum:
        name: "{{ MCPClient.osdeps_packages_2 | json_query('[].name') }}"
        state: "latest"
      when:
        - MCPClient.osdeps_packages_2 is defined and MCPClient.osdeps_packages_2

    - name: "Install MCPClient ext. package deps. (3) (RH/CentOS)"
      yum:
        name: "{{ MCPClient.osdeps_packages_3 | json_query('[].name') }}"
        state: "latest"
      when:
        - MCPClient.osdeps_packages_3 is defined and MCPClient.osdeps_packages_3

  when:
    - ansible_distribution == "RedHat" or ansible_distribution == "CentOS"
